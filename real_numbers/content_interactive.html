<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>平方根實驗室</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 + ReactDOM 18 + Babel (在瀏覽器編譯 JSX) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase compat（免打包、提供全域 firebase 物件） -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    .font-inter { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>

  <!-- 可選：在這裡填入你的 Firebase 設定（字串化 JSON）。不填就略過初始化、不報錯。 -->
  <script>
    // 例：window.__firebase_config = JSON.stringify({ apiKey:"...", authDomain:"...", projectId:"..." });
    window.__firebase_config = window.__firebase_config || JSON.stringify({});
    // 可選：自訂登入 token；未提供則使用匿名登入（若有設定）
    // window.__initial_auth_token = "YOUR_CUSTOM_TOKEN";
  </script>

  <!-- 你的 App（保留原結構；只把 import 換成 CDN，全域 firebase 物件） -->
  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    // Main App Component
    const App = () => {
      const [activeTab, setActiveTab] = useState('calculator'); // State to manage active tab
      const [db, setDb] = useState(null);
      const [auth, setAuth] = useState(null);

      // Firebase Initialization and Authentication
      useEffect(() => {
        try {
          // 幾乎不動你邏輯，只改成從 window 取字串並 JSON.parse
          const cfgStr = typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : "{}";
          let firebaseConfig = {};
          try { firebaseConfig = JSON.parse(cfgStr); } catch (e) { console.warn("Invalid __firebase_config JSON"); }

          if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
            // 使用 compat 版本全域 firebase
            const app = (firebase.apps && firebase.apps.length) ? firebase.app() : firebase.initializeApp(firebaseConfig);
            const firestoreDb = firebase.firestore();
            const firebaseAuth = firebase.auth();

            setDb(firestoreDb);
            setAuth(firebaseAuth);

            const signIn = async () => {
              try {
                if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                  await firebaseAuth.signInWithCustomToken(window.__initial_auth_token);
                } else {
                  await firebaseAuth.signInAnonymously();
                }
              } catch (error) {
                console.error("Firebase authentication error:", error);
              }
            };
            signIn();
          } else {
            // 沒有提供 Firebase 設定就跳過，不讓頁面報錯
            console.warn("Firebase not initialized: missing window.__firebase_config. App runs without auth/db.");
          }
        } catch (error) {
          console.error("Firebase initialization error:", error);
        }
      }, []);

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 font-inter text-gray-800 flex flex-col items-center">
          <h1 className="text-4xl font-extrabold text-indigo-700 mb-8 mt-4 text-center">平方根實驗室</h1>

          {/* Navigation Tabs */}
          <div className="flex flex-wrap justify-center gap-3 mb-8 w-full max-w-4xl">
            <TabButton label="根號計算機" tabId="calculator" activeTab={activeTab} setActiveTab={setActiveTab} />
            <TabButton label="根號數線圖" tabId="numberLine" activeTab={activeTab} setActiveTab={setActiveTab} />
          </div>

          {/* Content Area */}
          <div className="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-4xl flex-grow flex flex-col">
            {activeTab === 'calculator' && <Calculator />}
            {activeTab === 'numberLine' && <NumberLine />}
          </div>
        </div>
      );
    };

    // Tab Button Component
    const TabButton = ({ label, tabId, activeTab, setActiveTab }) => (
      <button
        className={`px-6 py-3 rounded-full text-lg font-semibold transition-all duration-300 ease-in-out
            ${activeTab === tabId
                ? 'bg-indigo-600 text-white shadow-lg transform scale-105'
                : 'bg-gray-200 text-gray-700 hover:bg-gray-300 hover:text-gray-800'
            }`}
        onClick={() => setActiveTab(tabId)}
      >
        {label}
      </button>
    );

    // Helper function for rounding or truncating
    const roundOrTruncate = (num, decimals, method) => {
      if (isNaN(num) || num === null) return null;
      if (method === 'round') {
          // Use toFixed for rounding, then convert back to number to remove trailing zeros
          return parseFloat(num.toFixed(decimals));
      } else if (method === 'truncate') {
          const factor = Math.pow(10, decimals);
          return Math.floor(num * factor) / factor;
      }
      return num; // Should not happen
    };

    // Section 1: Square Root Calculator
    const Calculator = () => {
      const [inputValue, setInputValue] = useState('');
      const [fullResult, setFullResult] = useState(null); // Stores the full calculated result
      const [processedResult, setProcessedResult] = useState(null); // Stores the result after precision handling
      const [explanation, setExplanation] = useState(''); // Stores the explanation text
      const [error, setError] = useState('');

      // State for precision settings
      const [selectedMethodType, setSelectedMethodType] = useState('round'); // 'round' or 'truncate'
      const [selectedWord, setSelectedWord] = useState('約至'); // Default selected word
      const [decimalPlaces, setDecimalPlaces] = useState(2); // Default decimal places

      // Mapping for words to method types
      const methodWords = {
          '算到': 'truncate',
          '準至': 'truncate',
          '約至': 'round',
          '取最近的': 'round',
      };

      const handleCalculate = () => {
          setError('');
          setFullResult(null);
          setProcessedResult(null);
          setExplanation('');

          const num = parseFloat(inputValue);

          if (isNaN(num)) {
              setError('請輸入有效的數字。');
              return;
          }
          if (num < 0) {
              setError('無法計算負數的平方根。');
              return;
          }

          const calculatedResult = Math.sqrt(num);
          setFullResult(calculatedResult);

          // Determine method type based on selected word
          const currentMethodType = methodWords[selectedWord];
          setSelectedMethodType(currentMethodType); // Update state for method type

          const finalProcessedResult = roundOrTruncate(calculatedResult, decimalPlaces, currentMethodType);
          setProcessedResult(finalProcessedResult);

          // Construct explanation
          let explanationText = `顯示為 ${finalProcessedResult}`;
          if (calculatedResult !== finalProcessedResult) { // Only add "因為你選的是" if actual rounding/truncation occurred
              explanationText += `，因為你選的是『${selectedWord}第 ${decimalPlaces} 位小數』`;
              if (currentMethodType === 'truncate') {
                  explanationText += '（無條件捨去）';
              } else {
                  explanationText += '（四捨五入）';
              }
          }
          setExplanation(explanationText);
      };

      // Function to clear all inputs and results
      const handleClear = () => {
          setInputValue('');
          setFullResult(null);
          setProcessedResult(null);
          setExplanation('');
          setError('');
          setSelectedWord('約至'); // Reset to default word
          setDecimalPlaces(2); // Reset to default decimal places
          setSelectedMethodType('round'); // Reset to default method type
      };

      return (
          <div className="flex flex-col items-center p-4">
              <h2 className="text-3xl font-bold text-indigo-600 mb-6">根號計算機</h2>
              <div className="w-full max-w-md bg-gray-50 p-6 rounded-lg shadow-inner">
                  {/* Input Area */}
                  <label htmlFor="sqrt-input" className="block text-lg font-medium text-gray-700 mb-2">
                      輸入一個數字：
                  </label>
                  <input
                      id="sqrt-input"
                      type="number"
                      value={inputValue}
                      onChange={(e) => setInputValue(e.target.value)}
                      placeholder="例如: 2, 9, 0.5"
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-lg mb-4"
                  />

                  {/* Precision Options Area */}
                  <p className="text-lg font-medium text-gray-700 mb-3">
                      如果題目這樣說，該怎麼處理小數？
                  </p>
                  <div className="space-y-3 mb-6">
                      {Object.keys(methodWords).map((word) => (
                          <div key={word} className="flex items-center">
                              <input
                                  type="radio"
                                  id={`word-${word}`}
                                  name="precisionWord"
                                  value={word}
                                  checked={selectedWord === word}
                                  onChange={(e) => setSelectedWord(e.target.value)}
                                  className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                              />
                              <label htmlFor={`word-${word}`} className="ml-2 text-base text-gray-700">
                                  {word}第
                              </label>
                              <select
                                  value={decimalPlaces}
                                  onChange={(e) => setDecimalPlaces(parseInt(e.target.value))}
                                  className="ml-2 block w-20 pl-3 pr-10 py-1 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                              >
                                  {Array.from({ length: 10 }, (_, i) => i + 1).map((num) => (
                                      <option key={num} value={num}>{num}</option>
                                  ))}
                              </select>
                              <span className="ml-2 text-base text-gray-700">位小數</span>
                          </div>
                      ))}
                  </div>

                  {/* Action Buttons */}
                  <div className="flex justify-center gap-4">
                      <button
                          onClick={handleCalculate}
                          className="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                      >
                          計算平方根
                      </button>
                      <button
                          onClick={handleClear}
                          className="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                      >
                          重置計算機
                      </button>
                  </div>

                  {error && (
                      <p className="mt-4 text-red-600 text-center font-medium">{error}</p>
                  )}

                  {fullResult !== null && !error && (
                      <div className="mt-6 p-4 bg-indigo-100 rounded-lg text-center shadow-sm">
                          <p className="text-xl font-semibold text-indigo-800">
                              完整平方根數值：
                          </p>
                          <p className="text-2xl font-extrabold text-indigo-900 mt-2 break-all">
                              {fullResult.toString()}...
                          </p>
                          <p className="text-xl font-semibold text-indigo-800 mt-4">
                              處理後結果：
                          </p>
                          <p className="text-4xl font-extrabold text-indigo-900 mt-2">
                              {processedResult !== null ? (
                                  parseFloat(processedResult) % 1 !== 0 ? `≈ ${processedResult}` : processedResult
                              ) : ''}
                          </p>
                          <p className="text-md text-gray-700 mt-2">
                              {explanation}
                          </p>
                      </div>
                  )}
              </div>
          </div>
      );
    };

    // Section 2: Square Root Number Line
    const NumberLine = () => {
      const canvasRef = useRef(null);
      const [radicandInput, setRadicandInput] = useState(0); // Slider value, default 0
      const [calculatedRoot, setCalculatedRoot] = useState(0); // Calculated square root, default 0
      const [displayDecimalPlaces, setDisplayDecimalPlaces] = useState(2); // For displaying the root, default 2
      const [error, setError] = useState('');

      // Effect to update calculatedRoot when radicandInput changes
      useEffect(() => {
          if (radicandInput >= 0) {
              setCalculatedRoot(Math.sqrt(radicandInput));
              setError('');
          } else {
              setError('被開方數不能是負數。');
              setCalculatedRoot(null);
          }
      }, [radicandInput]);

      // useCallback to memoize the drawing function, preventing unnecessary re-renders
      const drawNumberLine = useCallback(() => {
          const canvas = canvasRef.current;
          // Only draw if canvas exists and calculatedRoot is a valid number
          if (!canvas || calculatedRoot === null || isNaN(calculatedRoot)) {
              // Clear canvas if no valid root to plot
              if (canvas) {
                  const ctx = canvas.getContext('2d');
                  const dpr = window.devicePixelRatio || 1;
                  canvas.width = canvas.getBoundingClientRect().width * dpr;
                  canvas.height = canvas.getBoundingClientRect().width * dpr; // Make height proportional to width
                  ctx.scale(dpr, dpr);
                  ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
              }
              return;
          }

          const ctx = canvas.getContext('2d');
          const dpr = window.devicePixelRatio || 1; // Get device pixel ratio
          const rect = canvas.getBoundingClientRect();

          // Set canvas dimensions for high DPI displays
          canvas.width = rect.width * dpr;
          canvas.height = rect.height * dpr;
          ctx.scale(dpr, dpr);

          ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr); // Clear canvas

          const width = canvas.width / dpr;
          const height = canvas.height / dpr;
          const centerY = height / 2;

          // Fixed number line range from 0 to 10, with padding
          const paddingUnits = 1; // Units of padding on each side
          const displayStartNum = 0;
          const displayEndNum = 10;
          const actualStartNum = displayStartNum - paddingUnits;
          const actualEndNum = displayEndNum + paddingUnits;

          const visibleRange = actualEndNum - actualStartNum;
          const pixelsPerUnit = width / visibleRange; // Scale to fit the padded range in canvas width

          // Draw the line
          ctx.beginPath();
          ctx.moveTo(0, centerY);
          ctx.lineTo(width, centerY);
          ctx.strokeStyle = '#333';
          ctx.lineWidth = 2;
          ctx.stroke();

          // Draw tick marks and numbers for the fixed range 0-10 (and padding area)
          ctx.font = '14px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          ctx.fillStyle = '#333';

          // Draw ticks for the padded range
          for (let i = Math.floor(actualStartNum); i <= Math.ceil(actualEndNum); i++) {
              // Only label integers that are within the 0-10 range explicitly, or the padding integers
              if (i >= displayStartNum && i <= displayEndNum) {
                  const x = (i - actualStartNum) * pixelsPerUnit;
                  ctx.beginPath();
                  ctx.moveTo(x, centerY - 5);
                  ctx.lineTo(x, centerY + 5);
                  ctx.stroke();
                  ctx.fillText(i.toString(), x, centerY + 10);
              } else if (i === Math.floor(actualStartNum) || i === Math.ceil(actualEndNum)) {
                   // Optionally label the padding integers if they are integers
                  const x = (i - actualStartNum) * pixelsPerUnit;
                  ctx.beginPath();
                  ctx.moveTo(x, centerY - 5);
                  ctx.lineTo(x, centerY + 5);
                  ctx.stroke();
                  ctx.fillText(i.toString(), x, centerY + 10);
              }
          }

          // Plot the calculated square root, but only if it falls within the actual drawing range
          if (calculatedRoot >= actualStartNum && calculatedRoot <= actualEndNum) {
              const xPos = (calculatedRoot - actualStartNum) * pixelsPerUnit;
              ctx.beginPath();
              ctx.arc(xPos, centerY, 6, 0, Math.PI * 2); // Slightly larger dot
              ctx.fillStyle = '#10b981'; // Green dot
              ctx.fill();

              // Labels for the plotted point
              ctx.font = '12px Arial'; // Set font for labels
              ctx.fillStyle = '#333'; // Set fillStyle for labels
              ctx.fillText(`√${radicandInput}`, xPos, centerY - 20); // Radicand label
              ctx.fillText(`≈ ${calculatedRoot.toFixed(displayDecimalPlaces)}`, xPos, centerY - 35); // Processed root label
          } else if (calculatedRoot !== null && !isNaN(calculatedRoot)) {
               // Indicate if the root is outside the visible 0-10 range
               ctx.font = '14px Arial';
               ctx.fillStyle = '#ef4444'; // Red for warning
               ctx.textAlign = 'center';
               ctx.fillText(`√${radicandInput} ≈ ${calculatedRoot.toFixed(displayDecimalPlaces)} (超出數線範圍)`, width / 2, height - 20);
          }

      }, [calculatedRoot, radicandInput, displayDecimalPlaces]);

      useEffect(() => {
          drawNumberLine();
          const handleResize = () => drawNumberLine();
          window.addEventListener('resize', handleResize);
          return () => window.removeEventListener('resize', handleResize);
      }, [drawNumberLine]);

      // Function to reset the number line
      const handleResetNumberLine = () => {
          setRadicandInput(0);
          // calculatedRoot will update via useEffect
          setDisplayDecimalPlaces(2);
          setError('');
      };

      return (
          <div className="flex flex-col items-center p-4">
              <h2 className="text-3xl font-bold text-indigo-600 mb-6">根號數線定位顯示</h2>
              <div className="w-full max-w-3xl bg-gray-50 p-4 rounded-lg shadow-inner">
                  <p className="text-gray-700 mb-4 text-center">
                      拖動滑桿以改變被開方數（0-100），並在 0-10 的數線上觀察其平方根位置。
                  </p>

                  {/* Slider and value display */}
                  <div className="flex items-center justify-center mb-4">
                      <label htmlFor="radicand-slider" className="mr-3 text-lg font-medium text-gray-700">
                          被開方數:
                      </label>
                      <input
                          id="radicand-slider"
                          type="range"
                          min="0"
                          max="100" // Default range 0-100
                          step="0.1" // Allow decimal steps for slider
                          value={radicandInput}
                          onChange={(e) => setRadicandInput(parseFloat(e.target.value))}
                          className="w-64 accent-purple-500 cursor-pointer"
                      />
                      <span className="ml-3 text-xl font-bold text-purple-700">{radicandInput.toFixed(1)}</span>
                  </div>

                  {/* Decimal places dropdown */}
                  <div className="flex items-center justify-center mb-4">
                      <label htmlFor="decimal-places-select" className="mr-3 text-lg font-medium text-gray-700">
                          顯示小數位數:
                      </label>
                      <select
                          id="decimal-places-select"
                          value={displayDecimalPlaces}
                          onChange={(e) => setDisplayDecimalPlaces(parseInt(e.target.value))}
                          className="block w-20 pl-3 pr-10 py-1 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                      >
                          {Array.from({ length: 10 }, (_, i) => i + 1).map((num) => (
                              <option key={num} value={num}>{num}</option>
                          ))}
                      </select>
                  </div>

                  {/* Display current values */}
                  <div className="text-center mb-4 p-2 bg-purple-50 rounded-lg shadow-sm">
                      <p className="text-lg text-purple-800">
                          當前被開方數: <span className="font-semibold">{radicandInput.toFixed(1)}</span>
                      </p>
                      <p className="text-lg text-purple-800">
                          對應平方根: <span className="font-semibold">
                              {calculatedRoot !== null ? `≈ ${calculatedRoot.toFixed(displayDecimalPlaces)}` : 'N/A'}
                          </span>
                      </p>
                  </div>

                  {error && (
                      <p className="mt-2 text-red-600 text-center font-medium">{error}</p>
                  )}

                  {/* Canvas is always rendered, but draw function handles null calculatedRoot */}
                  <canvas
                      ref={canvasRef}
                      className="w-full h-48 bg-white border border-gray-300 rounded-lg shadow-md mt-6"
                      aria-label="平方根數線圖"
                  ></canvas>

                  <div className="flex justify-center mt-4">
                      <button
                          onClick={handleResetNumberLine}
                          className="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md"
                      >
                          重置數線
                      </button>
                  </div>
              </div>
          </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
